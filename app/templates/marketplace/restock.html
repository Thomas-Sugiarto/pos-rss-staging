{% extends "base.html" %}
{% block content %}

<!-- Debug Form Errors -->
{% if form.errors %}
<div class="alert alert-danger">
    <h5>Form Validation Errors:</h5>
    <ul>
        {% for field, errors in form.errors.items() %}
            <li><strong>{{ field }}</strong>:
                <ul>
                    {% for error in errors %}
                    <li>{{ error }}</li>
                    {% endfor %}
                </ul>
            </li>
        {% endfor %}
    </ul>
</div>
{% endif %}

<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5>Restock: {{ item.name }}</h5>
            </div>
            <div class="card-body">
                <form method="POST" enctype="multipart/form-data">
                    {{ form.hidden_tag() }}
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Harga per item</label>
                            <input type="text" class="form-control" value="{{ "Rp {:,.0f}".format(item.price) }}" readonly>
                        </div>
                        <div class="col-md-6">
                            {{ form.quantity.label(class="form-label") }}
                            {{ form.quantity(class="form-control") }}
                            {% for error in form.quantity.errors %}
                                <span class="text-danger">{{ error }}</span>
                            {% endfor %}
                        </div>
                    </div>

                    <!-- Total Amount -->
                    <div class="mb-3">
                        <label class="form-label">Total Harga</label>
                        <input type="text" class="form-control" id="totalAmount" value="{{ "Rp {:,.0f}".format(item.price) }}" readonly>
                    </div>

                    <!-- TAMBAHKAN BAGIAN INI: Destination Type Selection -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h6 class="mb-0"><i class="bi bi-bullseye"></i> Tujuan Pembelian</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-12">
                                    <div class="form-group">
                                        {{ form.destination_type.label(class="form-label") }}
                                        {{ form.destination_type(class="form-select") }}
                                        {% for error in form.destination_type.errors %}
                                            <span class="text-danger">{{ error }}</span>
                                        {% endfor %}
                                        <small class="form-text text-muted">
                                            Pilih "Produk" jika ingin dijual langsung ke pelanggan, "Bahan Baku" jika untuk diproduksi menjadi produk lain
                                        </small>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Informasi berdasarkan pilihan -->
                            <div id="product-info" class="alert alert-success mt-3" style="display: none;">
                                <div class="d-flex">
                                    <div class="flex-shrink-0">
                                        <i class="bi bi-box-seam fs-4"></i>
                                    </div>
                                    <div class="flex-grow-1 ms-3">
                                        <h6 class="alert-heading">Produk untuk Dijual</h6>
                                        <p class="mb-0">Item akan ditambahkan ke daftar <strong>produk</strong> Anda dan siap untuk dijual langsung kepada pelanggan.</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div id="raw-material-info" class="alert alert-info mt-3" style="display: none;">
                                <div class="d-flex">
                                    <div class="flex-shrink-0">
                                        <i class="bi bi-gear fs-4"></i>
                                    </div>
                                    <div class="flex-grow-1 ms-3">
                                        <h6 class="alert-heading">Bahan Baku untuk Produksi</h6>
                                        <p class="mb-0">Item akan ditambahkan ke inventaris <strong>bahan baku</strong> dan dapat digunakan untuk memproduksi produk lainnya.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- AKHIR BAGIAN YANG DITAMBAHKAN -->

                    <!-- Shipping Address Section -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h6 class="mb-0"><i class="bi bi-truck"></i> Alamat Pengiriman</h6>
                        </div>
                        <div class="card-body">
                            {% if tenant.address %}
                            <div class="mb-3">
                                <div class="form-check">
                                    {{ form.use_default_address(class="form-check-input") }}
                                    {{ form.use_default_address.label(class="form-check-label") }}
                                </div>
                                <div class="mt-2 p-3 border rounded bg-light" id="defaultAddress">
                                    <strong>{{ tenant.name }}</strong><br>
                                    {{ tenant.address }}<br>
                                    {{ tenant.city }} {{ tenant.postal_code }}<br>
                                    <i class="bi bi-telephone"></i> {{ tenant.phone }}
                                </div>
                            </div>
                            {% endif %}

                            <div id="customAddress" {% if tenant.address %}style="display: none;"{% endif %}>
                                <div class="mb-3">
                                    {{ form.shipping_address.label(class="form-label") }}
                                    {{ form.shipping_address(class="form-control", rows=3, placeholder="Masukkan alamat pengiriman") }}
                                    {% for error in form.shipping_address.errors %}
                                        <span class="text-danger">{{ error }}</span>
                                    {% endfor %}
                                </div>

                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        {{ form.shipping_city.label(class="form-label") }}
                                        {{ form.shipping_city(class="form-control", placeholder="Kota") }}
                                        {% for error in form.shipping_city.errors %}
                                            <span class="text-danger">{{ error }}</span>
                                        {% endfor %}
                                    </div>
                                    <div class="col-md-6">
                                        {{ form.shipping_postal_code.label(class="form-label") }}
                                        {{ form.shipping_postal_code(class="form-control", placeholder="Kode Pos") }}
                                        {% for error in form.shipping_postal_code.errors %}
                                            <span class="text-danger">{{ error }}</span>
                                        {% endfor %}
                                    </div>
                                </div>

                                <div class="mb-3">
                                    {{ form.shipping_phone.label(class="form-label") }}
                                    {{ form.shipping_phone(class="form-control", placeholder="Nomor telepon") }}
                                    {% for error in form.shipping_phone.errors %}
                                        <span class="text-danger">{{ error }}</span>
                                    {% endfor %}
                                </div>
                            </div>
                            
                            {% if not tenant.address %}
                            <div class="alert alert-warning">
                                <i class="bi bi-exclamation-triangle"></i>
                                Anda belum memiliki alamat default. 
                                <a href="{{ url_for('marketplace.my_address') }}">Tambahkan alamat</a> 
                                atau isi alamat pengiriman di bawah.
                            </div>
                            {% endif %}
                        </div>
                    </div>

                    <div class="mb-3">
                        {{ form.payment_proof.label(class="form-label") }}
                        {{ form.payment_proof(class="form-control") }}
                        {% for error in form.payment_proof.errors %}
                            <span class="text-danger">{{ error }}</span>
                        {% endfor %}
                        <div class="form-text">Upload bukti pembayaran (JPG, PNG, PDF)</div>
                    </div>

                    <div class="mb-3">
                        {{ form.notes.label(class="form-label") }}
                        {{ form.notes(class="form-control", rows=3, placeholder="Catatan untuk admin (opsional)") }}
                    </div>

                    <button type="submit" class="btn btn-primary">Submit Restock Order</button>
                    <a href="{{ url_for('marketplace.index') }}" class="btn btn-secondary">Cancel</a>
                </form>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h6>Payment Information</h6>
            </div>
            <div class="card-body">
                {% if payment_methods %}
                    <p class="text-muted small mb-3">Transfer tepat ke salah satu rekening berikut:</p>
                    {% for method in payment_methods %}
                    <div class="border p-3 mb-3 rounded">
                        <h6 class="text-primary">{{ method.name }}</h6>
                        <div class="mb-2">
                            <strong>Nomor Rekening:</strong><br>
                            <code>{{ method.account_number }}</code>
                        </div>
                        <div class="mb-2">
                            <strong>Nama Pemilik:</strong><br>
                            {{ method.account_name }}
                        </div>
                        {% if method.qr_code_url %}
                        <div class="text-center mt-3">
                            <img src="{{ method.qr_code_url }}" alt="QR Code {{ method.name }}" class="img-fluid border" style="max-width: 150px;">
                            <p class="small text-muted mt-1">Scan QR Code</p>
                        </div>
                        {% endif %}
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="text-center text-muted py-4">
                        <i class="bi bi-credit-card display-4"></i>
                        <p class="mt-2">Tidak ada metode pembayaran tersedia</p>
                        <small>Mohon kontak administrator untuk informasi pembayaran.</small>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Update total amount
    const quantityInput = document.querySelector('#quantity');
    const pricePerItem = {{ item.price }};
    const totalAmountInput = document.querySelector('#totalAmount');
    
    function updateTotalAmount() {
        const quantity = parseInt(quantityInput.value) || 1;
        const total = pricePerItem * quantity;
        totalAmountInput.value = 'Rp ' + total.toLocaleString('id-ID');
    }
    
    quantityInput.addEventListener('input', updateTotalAmount);
    updateTotalAmount();

    // Toggle custom address
    const useDefaultCheckbox = document.querySelector('#use_default_address');
    const defaultAddressDiv = document.querySelector('#defaultAddress');
    const customAddressDiv = document.querySelector('#customAddress');
    
    if (useDefaultCheckbox && defaultAddressDiv && customAddressDiv) {
        function toggleAddress() {
            if (useDefaultCheckbox.checked) {
                customAddressDiv.style.display = 'none';
                defaultAddressDiv.style.display = 'block';
            } else {
                customAddressDiv.style.display = 'block';
                defaultAddressDiv.style.display = 'none';
            }
        }
        
        useDefaultCheckbox.addEventListener('change', toggleAddress);
        toggleAddress();
    }

    // TAMBAHKAN: Toggle destination type info
    const destinationSelect = document.querySelector('#destination_type');
    const productInfo = document.querySelector('#product-info');
    const rawMaterialInfo = document.querySelector('#raw-material-info');
    
    function updateDestinationInfo() {
        const value = destinationSelect.value;
        
        if (value === 'product') {
            productInfo.style.display = 'block';
            rawMaterialInfo.style.display = 'none';
        } else if (value === 'raw_material') {
            productInfo.style.display = 'none';
            rawMaterialInfo.style.display = 'block';
        } else {
            productInfo.style.display = 'none';
            rawMaterialInfo.style.display = 'none';
        }
    }
    
    // Initial setup
    updateDestinationInfo();
    
    // Update on change
    if (destinationSelect) {
        destinationSelect.addEventListener('change', updateDestinationInfo);
    }
});
</script>
{% endblock %}