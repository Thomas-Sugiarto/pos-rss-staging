{% extends "base.html" %}

{% block title %}Edit Product - {{ product.name }} - POS System{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-2 text-gray-800">
                <i class="fas fa-edit me-2"></i>Edit Produk
            </h1>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item">
                        <a href="{{ url_for('products.index') }}">
                            <i class="fas fa-cubes me-1"></i>Produk
                        </a>
                    </li>
                    <li class="breadcrumb-item active">{{ product.name }}</li>
                </ol>
            </nav>
        </div>
        <div>
            <a href="{{ url_for('products.index') }}" class="btn btn-secondary">
                <i class="fas fa-arrow-left me-2"></i>Kembali ke Produk
            </a>
        </div>
    </div>

    <!-- Product Info Summary -->
    <div class="row mb-4">
        <div class="col-md-8">
            <div class="card shadow">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">
                        <i class="fas fa-info-circle me-2"></i>Informasi Produk Sekarang
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-2 text-center">
                            {% if product.image_url %}
                            <img src="{{ product.image_url }}" alt="{{ product.name }}" 
                                 class="img-thumbnail" style="width: 80px; height: 80px; object-fit: cover;">
                            {% else %}
                            <div class="bg-light rounded d-flex align-items-center justify-content-center" 
                                 style="width: 80px; height: 80px;">
                                <i class="fas fa-cube text-muted"></i>
                            </div>
                            {% endif %}
                        </div>
                        <div class="col-md-10">
                            <h4>{{ product.name }}</h4>
                            <div class="row">
                                <div class="col-md-4">
                                    <p class="mb-1"><strong>SKU:</strong> {{ product.sku }}</p>
                                    <p class="mb-1">
                                        <strong>Harga:</strong> 
                                        <span class="text-success">Rp{{ "{:,.0f}".format(product.price) }}</span>
                                    </p>
                                    {% if product.cost_price %}
                                    <p class="mb-1">
                                        <strong>Biaya:</strong> 
                                        Rp {{ "{:,.0f}".format(product.cost_price) }}
                                    </p>
                                    {% endif %}
                                </div>
                                <div class="col-md-4">
                                    <p class="mb-1">
                                        <strong>Stok:</strong> 
                                        {% if product.requires_stock_tracking %}
                                        {{ product.stock_quantity }} {{ product.unit }}
                                        {% else %}
                                        <span class="text-muted">No Tracking</span>
                                        {% endif %}
                                    </p>
                                    <p class="mb-1">
                                        <strong>Kategori:</strong> 
                                        {% if product.category %}
                                        {{ product.category.name }}
                                        {% else %}
                                        <span class="text-muted">Belum Dikategorikan</span>
                                        {% endif %}
                                    </p>
                                </div>
                                <div class="col-md-4">
                                    <p class="mb-1">
                                        <strong>Status:</strong> 
                                        {% if product.is_active %}
                                        <span class="badge bg-success">Aktif</span>
                                        {% else %}
                                        <span class="badge bg-secondary">Nonaktif</span>
                                        {% endif %}
                                    </p>
                                    <p class="mb-0">
                                        <strong>BOM:</strong> 
                                        {% if product.has_bom %}
                                        <span class="badge bg-info">Enabled</span>
                                        {% else %}
                                        <span class="badge bg-secondary">Disabled</span>
                                        {% endif %}
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card shadow">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">
                        <i class="fas fa-cogs me-2"></i>Quick Actions
                    </h6>
                </div>
                <div class="card-body text-center">
                    {% if product.has_bom %}
                    <a href="{{ url_for('bom.view_bom', product_id=product.id) }}" class="btn btn-info w-100 mb-2">
                        <i class="fas fa-list-alt me-2"></i>Lihat BOM
                    </a>
                    {% else %}
                    <a href="{{ url_for('bom.create_bom', product_id=product.id) }}" class="btn btn-outline-info w-100 mb-2">
                        <i class="fas fa-list-alt me-2"></i>Buat BOM
                    </a>
                    {% endif %}
                    
                    <form method="POST" action="{{ url_for('products.toggle_status', id=product.id) }}" class=" w-100 mb-2">
                        <button type="submit" class="btn {% if product.is_active %}btn-warning{% else %}btn-success{% endif %} w-100">
                            {% if product.is_active %}
                            <i class="fas fa-pause me-2"></i>Nonaktifkan
                            {% else %}
                            <i class="fas fa-play me-2"></i>Aktifkan
                            {% endif %}
                        </button>
                    </form>
                    
                    {% if product.sale_items.count() == 0 %}
                    <form method="POST" action="{{ url_for('products.delete', id=product.id) }}" 
                          class="d-inline w-100"
                          onsubmit="return confirm('Are you sure you want to delete {{ product.name }}? This action cannot be undone.');">
                        <button type="submit" class="btn btn-danger w-100">
                            <i class="fas fa-trash me-2"></i>Hapus Produk
                        </button>
                    </form>
                    {% else %}
                    <button class="btn btn-danger w-100" disabled title="Cannot delete product with sales history">
                        <i class="fas fa-trash me-2"></i>Hapus Produk
                    </button>
                    <small class="text-muted">Has sales history</small>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Form -->
    <div class="row">
        <div class="col-lg-8">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">
                        <i class="fas fa-edit me-2"></i>Ubah Informasi Produk
                    </h6>
                </div>
                <div class="card-body">
                    <form method="POST" action="{{ url_for('products.edit', id=product.id) }}" enctype="multipart/form-data" id="productForm">
                        {{ form.hidden_tag() }}
                        
                        <!-- Basic Information -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="name" class="form-label required">
                                        <i class="fas fa-tag me-1"></i>Nama Produk
                                    </label>
                                    {{ form.name(class="form-control", placeholder="Enter product name") }}
                                    {% if form.name.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.name.errors %}
                                        <i class="fas fa-exclamation-triangle me-1"></i>{{ error }}
                                        {% endfor %}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="category_id" class="form-label">
                                        <i class="fas fa-folder me-1"></i>Kategori
                                    </label>
                                    {{ form.category_id(class="form-select") }}
                                    {% if form.category_id.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.category_id.errors %}
                                        <i class="fas fa-exclamation-triangle me-1"></i>{{ error }}
                                        {% endfor %}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <!-- SKU and Barcode -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="sku" class="form-label">
                                        <i class="fas fa-barcode me-1"></i>SKU
                                    </label>
                                    {{ form.sku(class="form-control", placeholder="Stock keeping unit") }}
                                    <small class="form-text text-muted">Unique identifier for this product</small>
                                    {% if form.sku.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.sku.errors %}
                                        <i class="fas fa-exclamation-triangle me-1"></i>{{ error }}
                                        {% endfor %}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="barcode" class="form-label">
                                        <i class="fas fa-qrcode me-1"></i>Barcode
                                    </label>
                                    {{ form.barcode(class="form-control", placeholder="Optional barcode") }}
                                    {% if form.barcode.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.barcode.errors %}
                                        <i class="fas fa-exclamation-triangle me-1"></i>{{ error }}
                                        {% endfor %}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <!-- Pricing -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="price" class="form-label required">
                                        <i class="fas fa-money-bill-wave me-1"></i>Harga Jual
                                    </label>
                                    <div class="input-group">
                                        <span class="input-group-text">Rp</span>
                                        {{ form.price(class="form-control", placeholder="0", step="0.01", min="0") }}
                                    </div>
                                    {% if form.price.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.price.errors %}
                                        <i class="fas fa-exclamation-triangle me-1"></i>{{ error }}
                                        {% endfor %}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="cost_price" class="form-label">
                                        <i class="fas fa-receipt me-1"></i>Harga Beli
                                    </label>
                                    <div class="input-group">
                                        <span class="input-group-text">Rp</span>
                                        {{ form.cost_price(class="form-control", placeholder="0", step="0.01", min="0") }}
                                    </div>
                                    <small class="form-text text-muted">Perhitungan harga beli untuk keuntungan</small>
                                    {% if form.cost_price.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.cost_price.errors %}
                                        <i class="fas fa-exclamation-triangle me-1"></i>{{ error }}
                                        {% endfor %}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <!-- Unit and Packaging -->
                        <div class="row mb-4">
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="unit" class="form-label">
                                        <i class="fas fa-weight me-1"></i>Unit
                                    </label>
                                    {{ form.unit(class="form-select") }}
                                    {% if form.unit.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.unit.errors %}
                                        <i class="fas fa-exclamation-triangle me-1"></i>{{ error }}
                                        {% endfor %}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="carton_quantity" class="form-label">
                                        <i class="fas fa-box me-1"></i>Pieces per Carton
                                    </label>
                                    {{ form.carton_quantity(class="form-control", placeholder="1", min="1") }}
                                    <small class="form-text text-muted">For bulk packaging</small>
                                    {% if form.carton_quantity.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.carton_quantity.errors %}
                                        <i class="fas fa-exclamation-triangle me-1"></i>{{ error }}
                                        {% endfor %}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-check form-switch mt-4 pt-2">
                                    {{ form.requires_stock_tracking(class="form-check-input") }}
                                    <label class="form-check-label" for="requires_stock_tracking">
                                        Enable Stock Tracking
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- Stock Fields (Conditional) -->
                        <div id="stockFields" class="row mb-4" style="display: {% if product.requires_stock_tracking %}block{% else %}none{% endif %};">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="stock_quantity" class="form-label">Stok Sekarang</label>
                                    {{ form.stock_quantity(class="form-control", placeholder="0", min="0") }}
                                    {% if form.stock_quantity.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.stock_quantity.errors %}
                                        <i class="fas fa-exclamation-triangle me-1"></i>{{ error }}
                                        {% endfor %}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="stock_alert" class="form-label">Peringatan Stok Menipis</label>
                                    {{ form.stock_alert(class="form-control", placeholder="10", min="0") }}
                                    <small class="form-text text-muted">Peringatan saat stok mencapai level berikut</small>
                                    {% if form.stock_alert.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.stock_alert.errors %}
                                        <i class="fas fa-exclamation-triangle me-1"></i>{{ error }}
                                        {% endfor %}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <!-- BOM and Image -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <div class="form-check form-switch">
                                    {{ form.has_bom(class="form-check-input") }}
                                    <label class="form-check-label" for="has_bom">
                                        Gunakan Bill of Materials (BOM)
                                    </label>
                                </div>
                                <small class="form-text text-muted">
                                    Enable jika produk ini dibuat dari bahan mentah
                                    {% if product.has_bom and active_bom %}
                                    <br><span class="text-info">
                                        <i class="fas fa-check me-1"></i>BOM diatur
                                    </span>
                                    {% endif %}
                                </small>
                                
                                {% if product.has_bom and active_bom %}
                                <div class="mt-2">
                                    <small class="text-muted">
                                        <strong>Biaya BOM:</strong> Rp {{ "{:,.0f}".format(active_bom.calculate_total_cost()) }}<br>
                                        <strong>Item:</strong> {{ active_bom.items.count() }} materials
                                    </small>
                                </div>
                                {% endif %}
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="image" class="form-label">
                                        <i class="fas fa-image me-1"></i>Gambar Produk
                                    </label>
                                    {{ form.image(class="form-control", accept="image/*") }}
                                    <small class="form-text text-muted">
                                        {% if product.image_url %}
                                        Current image: <a href="{{ product.image_url }}" target="_blank">Lihat</a>
                                        {% else %}
                                        Upload product image (JPG/PNG, max 5MB)
                                        {% endif %}
                                    </small>
                                    {% if form.image.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.image.errors %}
                                        <i class="fas fa-exclamation-triangle me-1"></i>{{ error }}
                                        {% endfor %}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <!-- Description -->
                        <div class="form-group mb-4">
                            <label for="description" class="form-label">
                                <i class="fas fa-align-left me-1"></i>Deskripsi
                            </label>
                            {{ form.description(class="form-control", rows="3", placeholder="Enter product description...") }}
                            {% if form.description.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.description.errors %}
                                <i class="fas fa-exclamation-triangle me-1"></i>{{ error }}
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>

                        <!-- Status -->
                        <div class="form-check form-switch mb-4">
                            {{ form.is_active(class="form-check-input") }}
                            <label class="form-check-label" for="is_active">
                                Product sedang Aktif
                            </label>
                            <small class="form-text text-muted d-block">
                                Produk nonaktif tidak akan muncul di POS dan list produk
                            </small>
                        </div>

                        <!-- Form Actions -->
                        <div class="d-flex justify-content-between">
                            <a href="{{ url_for('products.index') }}" class="btn btn-secondary">
                                <i class="fas fa-times me-2"></i>Batal
                            </a>
                            <div>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save me-2"></i>Perbarui Produk
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Preview & Info Card -->
        <div class="col-lg-4">
            <!-- Preview Card -->
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">
                        <i class="fas fa-eye me-2"></i> Preview Produk
                    </h6>
                </div>
                <div class="card-body text-center">
                    <div id="imagePreview" class="mb-3">
                        {% if product.image_url %}
                        <img id="previewImage" src="{{ product.image_url }}" class="img-thumbnail" 
                             style="max-width: 200px; max-height: 200px;">
                        {% else %}
                        <div id="noImagePreview" class="text-muted">
                            <i class="fas fa-cube fa-3x mb-2"></i>
                            <p>Tidak ada gambar terpilih</p>
                        </div>
                        {% endif %}
                    </div>
                    <h6 id="previewName">{{ product.name }}</h6>
                    <p class="text-muted small" id="previewSku">SKU: {{ product.sku }}</p>
                    <p class="text-success" id="previewPrice">Rp {{ "{:,.0f}".format(product.price) }}</p>
                    <div class="mt-3">
                        {% if product.requires_stock_tracking %}
                        <span class="badge bg-info">Stock Tracking</span>
                        {% endif %}
                        {% if product.has_bom %}
                        <span class="badge bg-warning">BOM Enabled</span>
                        {% endif %}
                        {% if product.is_active %}
                        <span class="badge bg-success">Aktif</span>
                        {% else %}
                        <span class="badge bg-secondary">Nonaktif</span>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Sales Info Card -->
            <div class="card shadow">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">
                        <i class="fas fa-chart-bar me-2"></i>Informasi Penjualan
                    </h6>
                </div>
                <div class="card-body">
                    <div class="text-center mb-3">
                        <div class="display-6 text-primary">{{ product.sale_items.count() }}</div>
                        <small class="text-muted">Total Penjualan</small>
                    </div>
                    <div class="small">
    <p class="mb-1">
        <strong>Penjualan Terakhir:</strong><br>
        {% if product.last_sale_item %}
        {{ product.last_sale_item.sale.created_at.strftime('%d %b %Y') }}
        {% else %}
        <span class="text-muted">Belum ada penjualan</span>
        {% endif %}
    </p>
    <p class="mb-0">
        <strong>Total Pendapatan:</strong><br>
        <span class="text-success">
            Rp {{ "{:,.0f}".format(product.total_revenue) }}
        </span>
    </p>
</div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Toggle stock fields based on stock tracking checkbox
document.getElementById('requires_stock_tracking').addEventListener('change', function() {
    const stockFields = document.getElementById('stockFields');
    if (this.checked) {
        stockFields.style.display = 'block';
    } else {
        stockFields.style.display = 'none';
        
        // Reset stock values when disabling tracking
        document.getElementById('stock_quantity').value = 0;
        document.getElementById('stock_alert').value = 0;
    }
});

// Image preview for new image upload
document.getElementById('image').addEventListener('change', function(e) {
    const file = e.target.files[0];
    const preview = document.getElementById('imagePreview');
    const noPreview = document.getElementById('noImagePreview');
    const previewImage = document.getElementById('previewImage');
    
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            // Create image element if it doesn't exist
            if (!previewImage) {
                const img = document.createElement('img');
                img.id = 'previewImage';
                img.className = 'img-thumbnail';
                img.style.maxWidth = '200px';
                img.style.maxHeight = '200px';
                preview.innerHTML = '';
                preview.appendChild(img);
            }
            document.getElementById('previewImage').src = e.target.result;
            
            // Hide no image message
            if (noPreview) {
                noPreview.style.display = 'none';
            }
        }
        reader.readAsDataURL(file);
    } else {
        // Show no image message if no file selected and no existing image
        if (!'{{ product.image_url }}' && noPreview) {
            noPreview.style.display = 'block';
            if (previewImage) {
                previewImage.style.display = 'none';
            }
        }
    }
});

// Live preview updates
document.getElementById('name').addEventListener('input', function() {
    document.getElementById('previewName').textContent = this.value || 'Product Name';
});

document.getElementById('sku').addEventListener('input', function() {
    document.getElementById('previewSku').textContent = 'SKU: ' + (this.value || 'No SKU');
});

document.getElementById('price').addEventListener('input', function() {
    const price = parseFloat(this.value) || 0;
    document.getElementById('previewPrice').textContent = 'Rp ' + price.toLocaleString('id-ID');
});

// BOM warning when disabling
document.getElementById('has_bom').addEventListener('change', function() {
    if (!this.checked && {{ product.has_bom|lower }} && {{ product.bom_headers.count() > 0 }}) {
        if (!confirm('Disabling BOM will remove all existing BOM configurations for this product. Continue?')) {
            this.checked = true;
        }
    }
});

// Form validation
document.getElementById('productForm').addEventListener('submit', function(e) {
    const price = parseFloat(document.getElementById('price').value);
    if (price <= 0) {
        e.preventDefault();
        alert('Please enter a valid selling price greater than 0.');
        return false;
    }
    
    const stockTracking = document.getElementById('requires_stock_tracking').checked;
    if (stockTracking) {
        const stockQuantity = parseInt(document.getElementById('stock_quantity').value);
        if (stockQuantity < 0) {
            e.preventDefault();
            alert('Stock quantity cannot be negative.');
            return false;
        }
    }
    
    // Warn if disabling BOM with existing configuration
    const hasBom = document.getElementById('has_bom').checked;
    const existingBom = {{ product.has_bom|lower }} && {{ product.bom_headers.count() > 0 }};
    if (!hasBom && existingBom) {
        if (!confirm('Are you sure you want to disable BOM? All existing BOM configurations will be deleted.')) {
            e.preventDefault();
            return false;
        }
    }
});

// Initialize preview with current values
document.addEventListener('DOMContentLoaded', function() {
    // Update preview with current form values
    document.getElementById('previewName').textContent = document.getElementById('name').value || 'Product Name';
    document.getElementById('previewSku').textContent = 'SKU: ' + (document.getElementById('sku').value || 'No SKU');
    
    const price = parseFloat(document.getElementById('price').value) || 0;
    document.getElementById('previewPrice').textContent = 'Rp ' + price.toLocaleString('id-ID');
    
    // Handle image preview for existing image
    {% if product.image_url %}
    const noPreview = document.getElementById('noImagePreview');
    if (noPreview) {
        noPreview.style.display = 'none';
    }
    {% endif %}
});
</script>
{% endblock %}