{% extends "base.html" %}

{% block title %}Stock Alerts - KreasiPOS Enterprise{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="bi bi-exclamation-triangle text-warning"></i> Raw Material Stock Alerts</h2>
        <div>
            <a href="{{ url_for('raw_materials.index') }}" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> Back to Raw Materials
            </a>
            <a href="{{ url_for('marketplace.restock') }}" class="btn btn-primary">
                <i class="bi bi-cart-plus"></i> Restock from Marketplace
            </a>
        </div>
    </div>

    <!-- Alert Summary -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-danger text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4>{{ critical_count }}</h4>
                            <p class="mb-0">Critical (0 stock)</p>
                        </div>
                        <div class="align-self-center">
                            <i class="bi bi-exclamation-circle fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning text-dark">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4>{{ low_count }}</h4>
                            <p class="mb-0">Low Stock</p>
                        </div>
                        <div class="align-self-center">
                            <i class="bi bi-exclamation-triangle fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-info text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4>{{ total_materials }}</h4>
                            <p class="mb-0">Total Materials</p>
                        </div>
                        <div class="align-self-center">
                            <i class="bi bi-box fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4>{{ good_stock_count }}</h4>
                            <p class="mb-0">Good Stock</p>
                        </div>
                        <div class="align-self-center">
                            <i class="bi bi-check-circle fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Filter Options -->
    <div class="card mb-4">
        <div class="card-body">
            <div class="row">
                <div class="col-md-4">
                    <input type="text" id="searchMaterial" class="form-control" placeholder="Search materials...">
                </div>
                <div class="col-md-3">
                    <select id="alertFilter" class="form-select">
                        <option value="">All Alerts</option>
                        <option value="critical">Critical (0 stock)</option>
                        <option value="low">Low Stock</option>
                        <option value="good">Good Stock</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <select id="unitFilter" class="form-select">
                        <option value="">All Units</option>
                        {% for unit in units %}
                        <option value="{{ unit }}">{{ unit }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2">
                    <button class="btn btn-outline-secondary w-100" onclick="resetFilters()">
                        <i class="bi bi-arrow-clockwise"></i> Reset
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Materials List -->
    <div class="card">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover" id="materialsTable">
                    <thead class="table-dark">
                        <tr>
                            <th>Material</th>
                            <th>Current Stock</th>
                            <th>Alert Level</th>
                            <th>Status</th>
                            <th>Cost per Unit</th>
                            <th>Used in BOMs</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for material in materials %}
                        <tr class="material-row" 
                            data-name="{{ material.name.lower() }}"
                            data-unit="{{ material.unit }}"
                            data-status="{% if material.stock_quantity == 0 %}critical{% elif material.is_low_stock() %}low{% else %}good{% endif %}">
                            <td>
                                <div class="d-flex align-items-center">
                                    {% if material.stock_quantity == 0 %}
                                        <i class="bi bi-exclamation-circle text-danger me-2"></i>
                                    {% elif material.is_low_stock() %}
                                        <i class="bi bi-exclamation-triangle text-warning me-2"></i>
                                    {% else %}
                                        <i class="bi bi-check-circle text-success me-2"></i>
                                    {% endif %}
                                    <div>
                                        <strong>{{ material.name }}</strong>
                                        <br><small class="text-muted">SKU: {{ material.sku }}</small>
                                    </div>
                                </div>
                            </td>
                            <td>
                                <span class="fs-5 fw-bold 
                                    {% if material.stock_quantity == 0 %}text-danger
                                    {% elif material.is_low_stock() %}text-warning
                                    {% else %}text-success{% endif %}">
                                    {{ material.stock_quantity }}
                                </span>
                                <small class="text-muted">{{ material.unit }}</small>
                            </td>
                            <td>
                                <span class="badge bg-secondary">{{ material.stock_alert }} {{ material.unit }}</span>
                            </td>
                            <td>
                                {% if material.stock_quantity == 0 %}
                                    <span class="badge bg-danger">Critical</span>
                                {% elif material.is_low_stock() %}
                                    <span class="badge bg-warning">Low Stock</span>
                                {% else %}
                                    <span class="badge bg-success">Good Stock</span>
                                {% endif %}
                            </td>
                            <td>
                                Rp {{ "{:,.0f}".format(material.cost_price or 0) }}
                            </td>
                            <td>
                                {% set bom_count = material.bom_items.count() %}
                                {% if bom_count > 0 %}
                                    <span class="badge bg-info">{{ bom_count }} BOMs</span>
                                {% else %}
                                    <span class="text-muted">Not used</span>
                                {% endif %}
                            </td>
                            <td>
                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-outline-primary" onclick="quickAdjust('{{ material.id }}', '{{ material.name }}')" title="Quick Adjust">
                                        <i class="bi bi-arrow-repeat"></i>
                                    </button>
                                    <a href="{{ url_for('raw_materials.edit', id=material.id) }}" class="btn btn-outline-warning" title="Edit">
                                        <i class="bi bi-pencil"></i>
                                    </a>
                                    <button class="btn btn-outline-success" onclick="reorderMaterial('{{ material.id }}')" title="Reorder">
                                        <i class="bi bi-cart-plus"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Quick Adjust Modal -->
<div class="modal fade" id="adjustModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Quick Stock Adjustment</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Adjust stock for: <strong id="materialName"></strong></p>
                <div class="mb-3">
                    <label class="form-label">Adjustment Quantity</label>
                    <div class="input-group">
                        <input type="number" class="form-control" id="adjustmentQty" placeholder="Enter ± quantity">
                        <span class="input-group-text" id="materialUnit"></span>
                    </div>
                    <div class="form-text">Use positive numbers to add stock, negative to reduce</div>
                </div>
                <div class="mb-3">
                    <label class="form-label">Reason</label>
                    <select class="form-select" id="adjustmentReason">
                        <option value="manual_count">Manual Count Correction</option>
                        <option value="received">Stock Received</option>
                        <option value="damaged">Damaged/Expired</option>
                        <option value="used">Used in Production</option>
                        <option value="other">Other</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="confirmAdjustment()">Apply Adjustment</button>
            </div>
        </div>
    </div>
</div>

<script>
let currentMaterialId = null;

function quickAdjust(materialId, materialName) {
    currentMaterialId = materialId;
    document.getElementById('materialName').textContent = materialName;
    document.getElementById('adjustmentQty').value = '';
    new bootstrap.Modal(document.getElementById('adjustModal')).show();
}

function confirmAdjustment() {
    const qty = parseFloat(document.getElementById('adjustmentQty').value);
    const reason = document.getElementById('adjustmentReason').value;
    
    if (isNaN(qty)) {
        alert('Please enter a valid quantity.');
        return;
    }
    
    fetch('/raw_materials/adjust_stock', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('meta[name=csrf-token]').getAttribute('content')
        },
        body: JSON.stringify({
            material_id: currentMaterialId,
            quantity: qty,
            reason: reason
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Error adjusting stock: ' + data.message);
        }
    });
}

function reorderMaterial(materialId) {
    window.location.href = `/marketplace/restock?material_id=${materialId}`;
}

// Filter functionality
document.getElementById('searchMaterial').addEventListener('input', filterTable);
document.getElementById('alertFilter').addEventListener('change', filterTable);
document.getElementById('unitFilter').addEventListener('change', filterTable);

function filterTable() {
    const searchTerm = document.getElementById('searchMaterial').value.toLowerCase();
    const alertFilter = document.getElementById('alertFilter').value;
    const unitFilter = document.getElementById('unitFilter').value;
    
    document.querySelectorAll('.material-row').forEach(row => {
        const name = row.dataset.name;
        const status = row.dataset.status;
        const unit = row.dataset.unit;
        
        const matchesSearch = name.includes(searchTerm);
        const matchesAlert = !alertFilter || status === alertFilter;
        const matchesUnit = !unitFilter || unit === unitFilter;
        
        row.style.display = matchesSearch && matchesAlert && matchesUnit ? '' : 'none';
    });
}

function resetFilters() {
    document.getElementById('searchMaterial').value = '';
    document.getElementById('alertFilter').value = '';
    document.getElementById('unitFilter').value = '';
    filterTable();
}

// Auto-refresh every 5 minutes
setInterval(() => {
    location.reload();
}, 300000);
</script>
{% endblock %}